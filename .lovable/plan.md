
# Auth Flow Enhancement: Google Login, Password Recovery, Split Layout

## What Already Exists
- Supabase client configured at `src/integrations/supabase/client.ts` (hardcoded URL/key -- this is how Lovable projects work, no VITE_* env vars needed)
- `useAuth` hook with email/password sign in/up, admin check, session management
- `ProtectedRoute` and `AdminRoute` components
- Basic Auth page (login/signup toggle, centered card)
- Dark mode already default (`<html class="dark">`)
- `handle_new_user` trigger already creates profile + wallet + user_role on signup

## What Needs to Change

### 1. Auth Page Redesign (`src/pages/Auth.tsx`)
Rebuild into a modern split-layout page:
- **Desktop**: Left side with a cinematic gradient/illustration background + branding; right side with the form
- **Mobile**: Stacked -- branding header on top, form below
- Add multiple "views": Login, Register, Forgot Password, Reset Password
- Add Google OAuth button (uses `supabase.auth.signInWithOAuth`)
- Add "Esqueci minha senha" link on login view (calls `supabase.auth.resetPasswordForEmail`)
- Add `/auth?mode=reset` route handling for password reset callback (calls `supabase.auth.updateUser`)

### 2. `useAuth` Hook Enhancement (`src/hooks/useAuth.tsx`)
- Add `profile` state (fetched from `profiles` table after login)
- Add `signInWithGoogle()` method
- Add `resetPassword(email)` method
- Add `updatePassword(newPassword)` method
- Ensure profile + wallet exist after OAuth login (the DB trigger handles signup, but for safety add a check)
- Export `useRequireAuth()` hook that redirects to `/auth` if not authenticated

### 3. Routes Update (`src/App.tsx`)
- Add `/auth/reset-password` route for the password reset callback page
- Or handle via query params on `/auth`

### 4. Supabase Client -- NO changes needed
The client file is auto-generated by Lovable. The project is already connected to Supabase with hardcoded URL/key. VITE_* env vars are not supported in Lovable, so we keep the current setup.

### 5. Google OAuth -- User Action Required
Google OAuth requires configuring the Google provider in the Supabase dashboard. The code will be ready, but the user must:
1. Set up Google Cloud OAuth credentials
2. Enable Google provider in Supabase Auth settings
3. Configure redirect URLs

---

## Technical Details

### Auth Page Views
The Auth page will use a `mode` state: `"login" | "register" | "forgot" | "reset"`
- **Login**: Email + password fields, Google button, links to register and forgot password
- **Register**: Name + email + password fields, Google button, link to login
- **Forgot**: Email field only, sends reset email, link back to login
- **Reset**: New password + confirm password fields (accessed via email link with token in URL hash)

### useAuth Hook Changes
```
interface AuthContextType {
  session, user, loading, isAdmin (existing)
  profile: { id, display_name, avatar_url, auto_unlock } | null (new)
  signIn, signUp, signOut (existing)
  signInWithGoogle() (new)
  resetPassword(email) (new)
  updatePassword(newPassword) (new)
}
```

Profile is fetched via `onAuthStateChange` after session is set. The `useRequireAuth()` hook is a simple wrapper that calls `useAuth()` and navigates to `/auth` if no user after loading completes.

### useRequireAuth Hook
New export from `useAuth.tsx`:
```
export const useRequireAuth = () => {
  const auth = useAuth();
  const navigate = useNavigate();
  useEffect(() => {
    if (!auth.loading && !auth.user) navigate("/auth", { replace: true });
  }, [auth.loading, auth.user]);
  return auth;
};
```

### Split Layout Design
- Left panel: dark gradient background (purple-to-black matching the primary color), app logo, tagline, decorative elements
- Right panel: form card on dark card background
- Mobile: collapsed into single column with smaller branding header

### Files to Modify
- `src/hooks/useAuth.tsx` -- add profile, Google sign-in, password reset, useRequireAuth
- `src/pages/Auth.tsx` -- complete redesign with split layout and multiple views
- `src/App.tsx` -- minor: no new routes needed (handled via query params on /auth)

### Files NOT Modified
- `src/integrations/supabase/client.ts` -- auto-generated, keep as-is
- `src/components/ProtectedRoute.tsx` -- works fine as-is
- `src/components/AdminRoute.tsx` -- works fine as-is

### Important Notes
- Google OAuth will only work after the user configures it in their Supabase dashboard. We will display the button but show a helpful toast if it fails.
- Password reset flow: `resetPasswordForEmail` sends an email with a link back to the app. The `onAuthStateChange` event fires `PASSWORD_RECOVERY`, which we detect to show the reset form.
- No VITE_* env vars will be used (not supported in Lovable). URLs are hardcoded in the auto-generated client.
